tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - toscatranslator/providers/common/TOSCA_provider_definition_1_0.yaml
  - toscatranslator/providers/amazon/TOSCA_amazon_definition_1_0.yaml


topology_template:
  node_templates:
    tosca_server_example_group:
      type: amazon.nodes.Group
      properties:
        name: tosca_server_example_group
        rules:
          - cidr_ip: 0.0.0.0
            ports:
              - 22
            proto: tcp
    tosca_server_example_instance:
      type: amazon.nodes.Instance
      properties:
        name: tosca_server_example
        network:
          assign_public_ip: true
          private_ip_address: 192.168.12.28
        instance_type:
          get_operation_output:
            - tosca_server_example_server_instance_type
            - Target
            - choose
            - apiname
      requirements:
        - security_groups: tosca_server_example_group
        - image_id:
            node_filter:
              properties:
                - image_id:
                    get_operation_output:
                      - tosca_server_example_server_image_id
                      - Target
                      - choose
                      - image_id
  relationship_templates:
    tosca_server_example_server_image_id:
      type: amazon.relationships.DependsOn
      interfaces:
        Target:
          choose:
            implementation:
              - contains.yaml
              - tosca_server_example_ansible_set_fact.yaml
            inputs:
              input_args:
                - - architecture
                  - name
                - architecture: x86_64
                  distribution: xenial
                  type: ubuntu
                  version: 16.04
              input_facts:
                get_operation_output:
                  - SELF
                  - Target
                  - total
                  - target_objects
          total:
            implementation:
              - tosca_server_example_ansible_ec2_ami_facts.yaml
              - tosca_server_example_ansible_set_fact.yaml
    tosca_server_example_server_instance_type:
      type: amazon.relationships.DependsOn
      interfaces:
        Target:
          choose:
            implementation:
              - contains.yaml
              - tosca_server_example_ansible_set_fact.yaml
            inputs:
              input_args:
                - disk_size: 5 GiB
                  mem_size: 1024 MiB
                  num_cpus: 1
                - - vcpus
                  - memory
                  - storage
              input_facts:
                get_operation_output:
                  - SELF
                  - Target
                  - total
                  - target_objects
          total:
            implementation:
              - tosca_server_example_ansible_ec2_instance_type_facts.yaml
              - tosca_server_example_ansible_set_fact.yaml
